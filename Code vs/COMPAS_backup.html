<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMPAS - Environmental Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Previous CSS styles remain the same, adding data source styles */
        .data-source {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 10px;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }
        
        .data-source-icon {
            margin-right: 5px;
        }
        
        .data-source-list {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .data-source-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .data-source-item:last-child {
            border-bottom: none;
        }
        
        .api-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active {
            background-color: #2ecc71;
        }
        
        .status-warning {
            background-color: #f39c12;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">üåç</div>
                    <h1>COMPAS Environmental Dashboard</h1>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">JD</div>
                    <div id="userEmail">john.doe@epa.gov</div>
                    <button class="btn" id="logoutBtn" style="margin-left: 15px;">Logout</button>
                </div>
            </div>
        </header>
        
        <div class="dashboard">
            <!-- Weather Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Weather Conditions</div>
                    <div class="card-actions">
                        <button class="btn" onclick="updateTimeRange('weather', '24H')">24H</button>
                        <button class="btn" onclick="updateTimeRange('weather', '7D')">7D</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="weatherChart"></canvas>
                </div>
                <div class="data-source">
                    <span class="data-source-icon">üå§Ô∏è</span>
                    Data Source: National Weather Service API & NOAA
                </div>
            </div>
            
            <!-- Pollution Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Ground Air Pollution Measurements</div>
                    <div class="card-actions">
                        <button class="btn" onclick="updateTimeRange('pollution', '24H')">24H</button>
                        <button class="btn" onclick="updateTimeRange('pollution', '7D')">7D</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="pollutionChart"></canvas>
                </div>
                <div class="data-source">
                    <span class="data-source-icon">üè≠</span>
                    Data Source: EPA AirNow API, PurpleAir Network & NASA INSTEP Sensors
                </div>
            </div>
            
            <!-- TEMPO Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">TEMPO Satellite Data - NO‚ÇÇ Levels</div>
                    <div class="card-actions">
                        <button class="btn" onclick="updateTimeRange('tempo', '24H')">24H</button>
                        <button class="btn" onclick="updateTimeRange('tempo', '7D')">7D</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="tempoChart"></canvas>
                </div>
                <div class="data-source">
                    <span class="data-source-icon">üõ∞Ô∏è</span>
                    Data Source: NASA TEMPO L2 API (Near Real-Time)
                </div>
            </div>
            
            <!-- AQI Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Air Quality Index (AQI)</div>
                    <div class="card-actions">
                        <button class="btn" onclick="updateTimeRange('aqi', '24H')">24H</button>
                        <button class="btn" onclick="updateTimeRange('aqi', '7D')">7D</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="aqiChart"></canvas>
                </div>
                <div class="data-source">
                    <span class="data-source-icon">üìä</span>
                    Data Source: Composite Index (EPA + TEMPO + Ground Sensors)
                </div>
            </div>
            
            <!-- Data Sources Panel -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Active Data Sources & API Status</div>
                </div>
                <div class="data-source-list">
                    <div class="data-source-item">
                        <div>
                            <span class="api-status status-active"></span>
                            <strong>NASA TEMPO API</strong>
                        </div>
                        <div>Last update: 14:28 EST</div>
                    </div>
                    <div class="data-source-item">
                        <div>
                            <span class="api-status status-active"></span>
                            <strong>EPA AirNow API</strong>
                        </div>
                        <div>Last update: 14:25 EST</div>
                    </div>
                    <div class="data-source-item">
                        <div>
                            <span class="api-status status-active"></span>
                            <strong>National Weather Service</strong>
                        </div>
                        <div>Last update: 14:30 EST</div>
                    </div>
                    <div class="data-source-item">
                        <div>
                            <span class="api-status status-warning"></span>
                            <strong>PurpleAir Network</strong>
                        </div>
                        <div>3 stations offline</div>
                    </div>
                    <div class="data-source-item">
                        <div>
                            <span class="api-status status-active"></span>
                            <strong>OpenWeatherMap</strong>
                        </div>
                        <div>Last update: 14:29 EST</div>
                    </div>
                    <div class="data-source-item">
                        <div>
                            <span class="api-status status-active"></span>
                            <strong>NASA INSTEP Low-Cost Sensors</strong>
                        </div>
                        <div>Static Data (2023)</div>
                    </div>
                </div>
            </div>
            
            <!-- Map Container -->
            <div class="map-container">
                [Interactive Map Showing Pollution Sources and Monitoring Stations]
                <div class="data-source" style="position: absolute; bottom: 10px; left: 10px;">
                    <span class="data-source-icon">üó∫Ô∏è</span>
                    Map Data: OpenStreetMap + TEMPO Overlay + Facility Registry
                </div>
            </div>
            
            <!-- Insights Panel -->
            <div class="insights-panel">
                <div class="insights-header">
                    <div class="insights-title">Data Insights & Anomaly Detection</div>
                    <div class="card-actions">
                        <button class="btn" onclick="refreshInsights()">Refresh</button>
                    </div>
                </div>
                <div class="insights-content" id="insightsContainer">
                    <!-- Insights will be populated by JavaScript -->
                </div>
                <div class="data-source">
                    <span class="data-source-icon">ü§ñ</span>
                    Insights generated by ML Anomaly Detection Engine (TensorFlow.js)
                </div>
            </div>
        </div>
        
        <footer>
            <p>COMPAS - Compliance Monitoring & Pollution Attribution System | NASA TEMPO Data Integration</p>
            <p>Data last updated: <span id="lastUpdated">Today, 14:30 EST</span> | Next update in: <span id="nextUpdate">23 minutes</span></p>
        </footer>
    </div>

    <script>
        // Data Sources Configuration
        const DATA_SOURCES = {
            weather: {
                name: "National Weather Service API",
                endpoint: "https://api.weather.gov/gridpoints/",
                updateInterval: 900000, // 15 minutes
                status: "active"
            },
            pollution: {
                name: "EPA AirNow API + NASA INSTEP Sensors",
                endpoint: "https://airnowapi.org/aq/data/",
                updateInterval: 600000, // 10 minutes
                status: "active"
            },
            instep: {
                name: "NASA INSTEP Low-Cost Sensors",
                endpoint: "Data/staqs-AFRC-CH4-CH2O-O3-CO2_INSTEP_20230607_R0.ict",
                updateInterval: 86400000, // 24 hours (static data)
                status: "active"
            },
            tempo: {
                name: "NASA TEMPO API",
                endpoint: "https://tempo.sat.airquality.nasa.gov/api/",
                updateInterval: 300000, // 5 minutes
                status: "active"
            },
            aqi: {
                name: "Composite Data Fusion Engine",
                endpoint: "internal://data-fusion/",
                updateInterval: 300000,
                status: "active"
            }
        };

        // Global data storage
        let instepData = null;

        // Load and parse INSTEP data
        async function loadINSTEPData() {
            if (instepData) return instepData;
            try {
                const response = await fetch(DATA_SOURCES.instep.endpoint);
                const text = await response.text();
                const lines = text.split('\n');
                let dataStart = -1;
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('Time_Start')) {
                        dataStart = i + 1;
                        break;
                    }
                }
                if (dataStart === -1) throw new Error('Data start not found');
                const data = [];
                for (let i = dataStart; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    const parts = line.split(/\s+/);
                    if (parts.length >= 9) {
                        const timeMid = parseFloat(parts[2]);
                        const ch4 = parseFloat(parts[3]);
                        const ch2o = parseFloat(parts[4]);
                        const o3 = parseFloat(parts[5]);
                        const co2 = parseFloat(parts[6]);
                        const lat = parseFloat(parts[7]);
                        const lon = parseFloat(parts[8]);
                        data.push({ timeMid, ch4, ch2o, o3, co2, lat, lon });
                    }
                }
                instepData = data;
                return data;
            } catch (error) {
                console.error('Error loading INSTEP data:', error);
                return [];
            }
        }

        // User session management
        document.addEventListener('DOMContentLoaded', function() {
            const user = localStorage.getItem('compas_user');
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            document.getElementById('userEmail').textContent = user;
            document.getElementById('userAvatar').textContent = user.split('@')[0].substring(0, 2).toUpperCase();
            
            initializeCharts();
            loadInsights();
            startDataRefresh();
        });

        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('compas_user');
            window.location.href = 'login.html';
        });

        // Chart initialization (same as before, but with data source integration)
        async function initializeCharts() {
            // Weather Chart
            const weatherCtx = document.getElementById('weatherChart').getContext('2d');
            window.weatherChart = new Chart(weatherCtx, {
                type: 'line',
                data: await fetchWeatherData('24H'),
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { /* same as before */ }
                }
            });

            // Pollution Chart with INSTEP data integration
            const pollutionCtx = document.getElementById('pollutionChart').getContext('2d');
            const pollutionData = await fetchPollutionData('24H');
            window.pollutionChart = new Chart(pollutionCtx, {
                type: 'line',
                data: pollutionData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Concentration'
                            }
                        }
                    }
                }
            });
            
            // Initialize other charts similarly...
        }

        // Data fetching functions
        async function fetchWeatherData(range) {
            // Simulated API call - in production, this would fetch from actual APIs
            return {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                datasets: [
                    {
                        label: 'Temperature (¬∞F)',
                        data: [65, 63, 68, 75, 78, 72],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Wind Speed (mph)',
                        data: [5, 4, 3, 6, 8, 7],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            };
        }

        async function fetchTEMPOData(range) {
            // Simulated TEMPO data fetch
            console.log(`Fetching TEMPO data for ${range} from ${DATA_SOURCES.tempo.endpoint}`);
            // Actual implementation would use fetch() to NASA APIs
            return {
                labels: ['00:00', '02:00', '04:00', '06:00', '08:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00', '22:00'],
                datasets: [
                    {
                        label: 'Industrial Zone A',
                        data: [1.2, 1.4, 1.3, 1.8, 2.2, 2.5, 2.8, 3.1, 2.9, 2.5, 2.1, 1.7],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4
                    }
                ]
            };
        }

        async function fetchPollutionData(range) {
            const data = await loadINSTEPData();
            // For simplicity, use all data, assume range is 24H
            const labels = data.map(d => {
                const date = new Date('2023-06-07T00:00:00Z');
                date.setSeconds(date.getSeconds() + d.timeMid);
                return date.toISOString().substr(11, 5); // HH:MM
            });
            return {
                labels,
                datasets: [
                    {
                        label: 'CH4 (ppm)',
                        data: data.map(d => d.ch4),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'CH2O (ppb)',
                        data: data.map(d => d.ch2o),
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'O3 (ppb)',
                        data: data.map(d => d.o3),
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'CO2 (ppm)',
                        data: data.map(d => d.co2),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }
                ]
            };
        }

        function updateTimeRange(chartType, range) {
            // Update chart data based on selected time range
            console.log(`Updating ${chartType} chart for ${range}`);
            // Implementation would fetch new data and update the chart
        }

        function loadInsights() {
            const insights = [
                {
                    title: "Elevated NO‚ÇÇ Levels Detected",
                    text: "TEMPO satellite data shows a 42% increase in nitrogen dioxide levels over Industrial Zone B.",
                    status: "poor",
                    source: "NASA TEMPO + Anomaly Detection"
                },
                {
                    title: "Weather Impact on Pollution Dispersion",
                    text: "Low wind speeds preventing normal pollutant dispersion. Expect AQI deterioration.",
                    status: "moderate",
                    source: "NWS + EPA Correlation Engine"
                },
                {
                    title: "Compliance Violation Alert",
                    text: "Ground sensors show PM2.5 levels exceeding regulatory limits at Thompson Chemical.",
                    status: "poor",
                    source: "EPA AirNow + Compliance Database"
                }
            ];

            const container = document.getElementById('insightsContainer');
            container.innerHTML = insights.map(insight => `
                <div class="insight-card ${insight.status === 'poor' ? 'warning' : ''}">
                    <div class="insight-title">
                        <span class="status-indicator status-${insight.status}"></span>
                        ${insight.title}
                    </div>
                    <div class="insight-text">${insight.text}</div>
                    <div class="data-source" style="margin-top: 8px; font-size: 11px;">
                        Source: ${insight.source}
                    </div>
                </div>
            `).join('');
        }

        function refreshInsights() {
            // Simulate refreshing insights
            console.log("Refreshing insights from data sources...");
            loadInsights();
        }

        function startDataRefresh() {
            // Set up periodic data refresh
            setInterval(() => {
                console.log("Auto-refreshing dashboard data...");
                // In production, this would trigger API calls and chart updates
                updateLastRefreshedTime();
            }, 300000); // 5 minutes
        }

        function updateLastRefreshedTime() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = 
                `Today, ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')} EST`;
        }

        // Initialize other charts (pollutionChart, tempoChart, aqiChart) similarly...
    </script>
</body>
</html>