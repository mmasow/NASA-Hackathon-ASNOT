<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>COMPAS Environmental Dashboard</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <style>
      :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #1abc9c;
        --warning-color: #e74c3c;
        --moderate-color: #f39c12;
        --light-color: #ecf0f1;
        --dark-color: #2c3e50;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      body {
        background: #f5f7fa;
        color: #333;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: #fff;
        padding: 20px 0;
        border-radius: 10px;
        margin-bottom: 20px;
      }
      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
      }
      .logo {
        display: flex;
        align-items: center;
      }
      .logo h1 {
        font-size: 28px;
        margin-left: 10px;
      }
      .logo-icon {
        font-size: 32px;
      }
      .user-info {
        display: flex;
        align-items: center;
      }
      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--accent-color);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-weight: bold;
      }
      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }
      .card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 20px;
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      .card-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--primary-color);
      }
      .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
      }
      .map-container {
        height: 500px;
        background: #e0e7ff;
        border-radius: 8px;
        margin-top: 20px;
        grid-column: 1 / -1;
        position: relative;
      }
      #interactiveMap {
        height: 100%;
        width: 100%;
        border-radius: 8px;
      }
      .map-legend {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
      }
      .legend-color {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        border-radius: 3px;
      }
      .insights-panel {
        grid-column: 1 / -1;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        padding: 20px;
        margin-top: 20px;
      }
      .insight-card {
        background: var(--light-color);
        border-radius: 8px;
        padding: 15px;
        border-left: 4px solid var(--accent-color);
        margin-bottom: 10px;
      }
      .insight-card.warning {
        border-left-color: var(--warning-color);
      }
      .insight-card.moderate {
        border-left-color: var(--moderate-color);
      }
      .insight-title {
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--dark-color);
      }
      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
      }
      .status-good {
        background-color: #2ecc71;
      }
      .status-moderate {
        background-color: #f39c12;
      }
      .status-poor {
        background-color: #e74c3c;
      }
      textarea {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      .alert-container {
        grid-column: 1 / -1;
        margin-bottom: 15px;
      }
      .alert {
        padding: 12px 15px;
        border-radius: 6px;
        color: #fff;
        margin-bottom: 8px;
        font-weight: bold;
        animation: fadein 0.5s;
      }
      .alert.critical {
        background-color: var(--warning-color);
      }
      .alert.moderate {
        background-color: var(--moderate-color);
      }
      @keyframes fadein {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .card-actions {
        display: flex;
        gap: 10px;
      }
      .btn {
        padding: 6px 12px;
        border: 1px solid #007bff;
        background: white;
        color: #007bff;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      .btn:hover {
        background: #007bff;
        color: white;
      }
      #logoutBtn, #forecastBtn {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border: none;
        margin-left: 10px;
      }
      .data-source {
        font-size: 12px;
        color: #7f8c8d;
        margin-top: 10px;
        padding: 5px 20px;
        background: #f8f9fa;
        border-radius: 4px;
        display: flex;
        align-items: center;
      }
      .data-source-icon {
        margin-right: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="header-content">
          <div class="logo">
            <div class="logo-icon">üåç</div>
            <h1>COMPAS Environmental Dashboard</h1>
          </div>
          <div class="user-info">
            <div class="user-avatar" id="userAvatar">AD</div>
            <button id="forecastBtn" class="btn" onclick="window.location.href='predictions.html'">Forecast</button>
            <button id="logoutBtn" class="btn" onclick="window.location.href='Login.html'">Logout</button>
          </div>
        </div>
      </header>

      <!-- Alerts -->
      <div class="alert-container" id="alertContainer"></div>

      <div class="dashboard">
        <!-- Weather Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Weather Conditions</div>
          </div>
          <div class="chart-container"><canvas id="weatherChart"></canvas></div>
        </div>

        <!-- Pollution Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Ground Air Pollution Measurements</div>
            <div class="card-actions">
              <button class="btn" onclick="updateTimeRange('pollution', '24H')">24H</button>
              <button class="btn" onclick="updateTimeRange('pollution', '7D')">7D</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="pollutionChart"></canvas>
          </div>
          <div class="data-source">
            <span class="data-source-icon">üè≠</span>
            Data Source: NASA INSTEP Data
          </div>
        </div>

        <!-- TEMPO Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">TEMPO Satellite Data - NO‚ÇÇ Levels</div>
            <div class="card-actions">
              <button class="btn" onclick="updateTimeRange('tempo', '24H')">24H</button>
              <button class="btn" onclick="updateTimeRange('tempo', '7D')">7D</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="tempoChart"></canvas>
          </div>
          <div class="data-source">
            <span class="data-source-icon">üõ∞Ô∏è</span>
            Data Source: NASA TEMPO L2 API (Near Real-Time)
          </div>
        </div>

        <!-- AQI Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Air Quality Index (AQI)</div>
            <div class="card-actions">
              <button class="btn" onclick="updateTimeRange('aqi', '24H')">24H</button>
              <button class="btn" onclick="updateTimeRange('aqi', '7D')">7D</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="aqiChart"></canvas>
          </div>
          <div class="data-source">
            <span class="data-source-icon">üìä</span>
            Data Source: Composite Index (EPA + TEMPO + Ground Sensors)
          </div>
        </div>

        <!-- Map -->
        <div class="map-container">
          <div id="interactiveMap"></div>
          <div class="map-legend">
            <h4>Legend</h4>
            <div class="legend-item">
              <div class="legend-color" style="background: #e74c3c"></div>
              High Pollution
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #f39c12"></div>
              Moderate Pollution
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #2ecc71"></div>
              Low Pollution
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #3498db"></div>
              Weather Station
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #9b59b6"></div>
              Industrial Facility
            </div>
          </div>
        </div>

        <!-- Insights Panel -->
        <div class="insights-panel" id="insightsPanel">
          <h3>Data Insights & Anomalies</h3>
          <div id="insightsContainer"></div>
          <h4>Submit an Enquiry / Feedback</h4>
          <textarea
            id="userEnquiry"
            rows="4"
            placeholder="Type your question or feedback here..."
          ></textarea>
          <button class="btn" onclick="submitEnquiry()">Submit Enquiry</button>
          <div id="enquiryStatus" style="margin-top: 10px"></div>
        </div>
      </div>
    </div>

    <script>
      let map;
      let charts = {};
      let doasData = null;

      document.addEventListener('DOMContentLoaded', async function() {
        await loadDOASData();
        initializeMap();
        await initializeCharts();
        loadMapData();
        generateInsightsAndAlerts();
        setInterval(checkTempoAnomalies, 60000);
      });

      // Initialize Map
      function initializeMap() {
        map = L.map("interactiveMap").setView([36.7783, -119.4179], 6);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 18,
          attribution: "¬© OpenStreetMap",
        }).addTo(map);
      }

      // Sample factories
      const factories = [
        { name: "Los Angeles Refinery", lat: 33.85, lon: -118.22, ch2o: 3.2 },
        { name: "San Francisco Plant", lat: 37.77, lon: -122.42, ch2o: 2.8 },
        {
          name: "Bakersfield Chemical Co.",
          lat: 35.37,
          lon: -119.02,
          ch2o: 1.5,
        },
        { name: "Port of Long Beach Hub", lat: 33.75, lon: -118.2, ch2o: 2.5 },
      ];

      function loadMapData() {
        factories.forEach((f) => {
          L.circleMarker([f.lat, f.lon], {
            radius: 8,
            fillColor: getColorByCH2O(f.ch2o),
            color: "#000",
            fillOpacity: 0.9,
          })
            .addTo(map)
            .bindPopup(`<b>${f.name}</b><br>CH2O: ${f.ch2o} ppb`);
        });
      }

      function getColorByCH2O(v) {
        if (v <= 2) return "#2ecc71";
        if (v <= 3) return "#f39c12";
        return "#e74c3c";
      }

      // Load INSTEP data from .ict file
      async function loadDOASData() {
        if (doasData) return doasData;
        try {
          const response = await fetch('../staqs-AFRC-CH4-CH2O-O3-CO2_INSTEP_20230607_R0.ict');
          const text = await response.text();
          const lines = text.split('\n');
          // Find the header line
          let headerIndex = -1;
          for (let i = 0; i < lines.length; i++) {
            if (lines[i].includes('Time_Start,Time_Stop,Time_Mid,CH4,CH2O,O3,CO2,Latitude,Longitude')) {
              headerIndex = i;
              break;
            }
          }
          if (headerIndex === -1) throw new Error('Header not found');
          const dataLines = lines.slice(headerIndex + 1);
          const data = [];
          for (const line of dataLines) {
            if (line.trim() === '') continue;
            const parts = line.split('\t');
            if (parts.length >= 9) {
              const time = new Date(parts[0]);
              const ch4 = parseFloat(parts[3]);
              const ch2o = parseFloat(parts[4]);
              const o3 = parseFloat(parts[5]);
              const co2 = parseFloat(parts[6]);
              if (!isNaN(time.getTime()) && !isNaN(ch4) && !isNaN(ch2o) && !isNaN(o3) && !isNaN(co2)) {
                data.push({ time, ch4, ch2o, o3, co2 });
              }
            }
          }
          doasData = data;
          return data;
        } catch (error) {
          console.error('Error loading DOAS data:', error);
          // Fallback to dummy data
          const data = [];
          const startTime = new Date('2023-06-07T00:00:00Z');
          for (let i = 0; i < 144; i++) { // 6 hours of data (10 min intervals)
            const time = new Date(startTime.getTime() + i * 10 * 60 * 1000);
            data.push({
              time: time,
              ch4: 1800 + Math.random() * 200, // ppb
              ch2o: 2.5 + Math.random() * 1, // ppb
              o3: 35 + Math.random() * 10, // ppb
              co2: 420 + Math.random() * 20 // ppm
            });
          }
          doasData = data;
          return data;
        }
      }

      async function fetchTEMPOData(range) {
        // Simulated TEMPO data fetch
        return {
          labels: ['00:00', '02:00', '04:00', '06:00', '08:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00', '22:00'],
          datasets: [
            {
              label: 'NO‚ÇÇ Levels',
              data: [1.2, 1.4, 1.3, 1.8, 2.2, 2.5, 2.8, 3.1, 2.9, 2.5, 2.1, 1.7],
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              tension: 0.4
            }
          ]
        };
      }

      async function fetchAQIData(range) {
        // Simulated AQI data
        return {
          labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
          datasets: [
            {
              label: 'AQI',
              data: [45, 52, 48, 65, 78, 62],
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              tension: 0.4
            }
          ]
        };
      }

      async function fetchPollutionData(range) {
        const data = await loadDOASData();
        // Sample data for performance, take every 10th point
        const sampledData = data.filter((_, i) => i % 10 === 0);
        const labels = sampledData.map(d => d.time.toLocaleString());
        return {
          labels,
          datasets: [
            {
              label: 'CH4 (ppb)',
              data: sampledData.map(d => d.ch4),
              borderColor: '#9b59b6',
              backgroundColor: 'rgba(155, 89, 182, 0.1)',
              tension: 0.4
            },
            {
              label: 'CH2O (ppb)',
              data: sampledData.map(d => d.ch2o),
              borderColor: '#f39c12',
              backgroundColor: 'rgba(243, 156, 18, 0.1)',
              tension: 0.4
            },
            {
              label: 'O3 (ppb)',
              data: sampledData.map(d => d.o3),
              borderColor: '#2ecc71',
              backgroundColor: 'rgba(46, 204, 113, 0.1)',
              tension: 0.4
            },
            {
              label: 'CO2 (ppm)',
              data: sampledData.map(d => d.co2),
              borderColor: '#e67e22',
              backgroundColor: 'rgba(230, 126, 34, 0.1)',
              tension: 0.4
            }
          ]
        };
      }

      // Initialize Charts
      async function initializeCharts() {
        charts.weather = new Chart(
          document.getElementById("weatherChart").getContext("2d"),
          createChartConfig("line", "Temperature (¬∞F)", "#e74c3c")
        );

        // TEMPO Chart
        const tempoCtx = document.getElementById('tempoChart').getContext('2d');
        const tempoData = await fetchTEMPOData('24H');
        window.tempoChart = new Chart(tempoCtx, {
          type: 'line',
          data: tempoData,
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
        charts.tempo = window.tempoChart;

        // Pollution Chart
        const pollutionCtx = document.getElementById('pollutionChart').getContext('2d');
        const pollutionData = await fetchPollutionData('24H');
        window.pollutionChart = new Chart(pollutionCtx, {
          type: 'line',
          data: pollutionData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                type: 'linear',
                position: 'left',
                title: {
                  display: true,
                  text: 'Concentration'
                }
              }
            }
          }
        });
        charts.pollution = window.pollutionChart;

        // AQI Chart
        const aqiCtx = document.getElementById('aqiChart').getContext('2d');
        const aqiData = await fetchAQIData('24H');
        window.aqiChart = new Chart(aqiCtx, {
          type: 'line',
          data: aqiData,
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
        charts.aqi = window.aqiChart;

        simulateChartData();
      }

      function createChartConfig(type, label, color) {
        return {
          type: type,
          data: {
            labels: [],
            datasets: [
              {
                label: label,
                data: [],
                borderColor: color,
                backgroundColor: color + "20",
                fill: type === "line",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
          },
        };
      }

      function simulateChartData() {
        const labels = [];
        const weatherData = [];
        const now = Date.now();
        for (let i = 0; i < 24; i++) {
          labels.push(new Date(now - i * 3600000).getHours() + ":00");
          weatherData.push(Math.random() * 15 + 50);
        }
        charts.weather.data.labels = labels;
        charts.weather.data.datasets[0].data = weatherData;
        charts.weather.update();
      }

      // Generate Insights & Alerts
      function generateInsightsAndAlerts() {
        const insights = [];
        const alerts = [];
        factories.forEach((f) => {
          if (f.ch2o > 3) {
            insights.push({
              title: `High Pollution Alert: ${f.name}`,
              text: `CH2O level at ${f.ch2o} ppb exceeds safe limits.`,
              status: "poor",
            });
            alerts.push({
              message: `‚ö† Critical Pollution Alert at ${f.name}: CH2O ${f.ch2o} ppb`,
              type: "critical",
            });
          } else if (f.ch2o > 2) {
            insights.push({
              title: `Moderate Pollution: ${f.name}`,
              text: `CH2O level at ${f.ch2o} ppb is moderate.`,
              status: "moderate",
            });
            alerts.push({
              message: `Moderate Pollution Alert at ${f.name}: CH2O ${f.ch2o} ppb`,
              type: "moderate",
            });
          } else {
            insights.push({
              title: `Low Pollution: ${f.name}`,
              text: `CH2O level at ${f.ch2o} ppb is within safe range.`,
              status: "good",
            });
          }
        });

        displayInsights(insights);
        displayAlerts(alerts);
      }

      function displayInsights(insights) {
        const container = document.getElementById("insightsContainer");
        container.innerHTML = insights
          .map(
            (i) => `
        <div class="insight-card ${
          i.status === "poor"
            ? "warning"
            : i.status === "moderate"
            ? "moderate"
            : ""
        }">
          <div class="insight-title"><span class="status-indicator status-${
            i.status
          }"></span>${i.title}</div>
          <div class="insight-text">${i.text}</div>
        </div>`
          )
          .join("");
      }

      function displayAlerts(alerts) {
        const alertContainer = document.getElementById("alertContainer");
        // Replace existing alerts entirely
        alertContainer.innerHTML = alerts
          .map((a) => `<div class="alert ${a.type}">${a.message}</div>`)
          .join("");
      }

      // TEMPO Anomaly Check
      function checkTempoAnomalies() {
        // Simulate TEMPO NO2 latest reading (replace with actual API fetch)
        const latestNO2 = Math.random() * 60; // Replace with real NASA TEMPO data
        const alerts = [];
        if (latestNO2 > 50) {
          alerts.push({
            message: `‚ö† TEMPO Satellite Alert: NO‚ÇÇ level high at ${latestNO2.toFixed(
              2
            )} ¬µg/m¬≥`,
            type: "critical",
          });
        } else if (latestNO2 > 25) {
          alerts.push({
            message: `Moderate TEMPO NO‚ÇÇ level: ${latestNO2.toFixed(2)} ¬µg/m¬≥`,
            type: "moderate",
          });
        }

        // Display alerts in the alert container
        displayAlerts(alerts);
      }

      // Submit Enquiry
      function submitEnquiry() {
        const enquiry = document.getElementById("userEnquiry").value.trim();
        const statusDiv = document.getElementById("enquiryStatus");
        if (enquiry === "") {
          statusDiv.style.color = "red";
          statusDiv.innerText = "Please type your enquiry.";
          return;
        }
        console.log("User Enquiry Submitted:", enquiry);
        statusDiv.style.color = "green";
        statusDiv.innerText =
          "‚úÖ Your enquiry has been submitted. Our team will review it.";
        document.getElementById("userEnquiry").value = "";
      }

      // Update Time Range
      function updateTimeRange(chartType, range) {
        console.log(`Updating ${chartType} chart to ${range} range`);
        // Simulate data update for the selected time range
        const labels = [];
        const data = [];
        const now = Date.now();
        const hours = range === '24H' ? 24 : 168; // 7 days = 168 hours
        for (let i = 0; i < hours; i++) {
          labels.push(new Date(now - i * 3600000).toLocaleString());
          data.push(Math.random() * 50);
        }
        charts[chartType].data.labels = labels;
        charts[chartType].data.datasets[0].data = data;
        charts[chartType].update();
      }
    </script>
  </body>
</html>
